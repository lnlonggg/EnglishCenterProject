@model TrungTamAnhNgu.Web.ViewModels.ClassViewModel
@using TrungTamAnhNgu.Web.Models

@{
    ViewData["Title"] = "Chỉnh sửa Lớp học";
}

<h1 class="text-3xl font-bold text-gray-800 mb-6">@ViewData["Title"]</h1>

<div class="bg-white shadow-md rounded-lg p-8 max-w-2xl">
    <form asp-action="Edit">
        <div asp-validation-summary="ModelOnly" class="text-red-600 text-sm mb-4" role="alert"></div>
        <input type="hidden" asp-for="Id" />

        <div class="mb-4">
            <label asp-for="ClassName" class="block text-sm font-medium text-gray-700"></label>
            <input asp-for="ClassName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
            <span asp-validation-for="ClassName" class="text-red-600 text-sm"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="CourseId" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="CourseId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" asp-items="ViewBag.CourseId"></select>
            </div>
            <div>
                <label asp-for="TeacherId" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="TeacherId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" asp-items="ViewBag.TeacherId"></select>
            </div>
        </div>

        @* --- BẮT ĐẦU: GIAO DIỆN CHỌN LỊCH HỌC (EDIT) --- *@
        <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <label class="block text-sm font-bold text-gray-700 mb-2">Lịch học</label>

            <input asp-for="Schedule" type="hidden" id="ScheduleInput" />
            <span asp-validation-for="Schedule" class="text-red-600 text-sm"></span>

            @* Chọn Thứ *@
            <div class="mb-3">
                <span class="text-xs font-semibold text-gray-500 uppercase">Thứ:</span>
                <div class="flex flex-wrap gap-3 mt-2">
                    @foreach (var day in new[] { "T2", "T3", "T4", "T5", "T6", "T7", "CN" })
                    {
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="@day" class="schedule-day form-checkbox h-5 w-5 text-brand-blue rounded border-gray-300" />
                            <span class="ml-2 text-sm text-gray-700">@day</span>
                        </label>
                    }
                </div>
            </div>

            @* Chọn Ca *@
            <div>
                <span class="text-xs font-semibold text-gray-500 uppercase">Ca học:</span>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                    @{
                        var shifts = new Dictionary<string, string>
                                        {
                                        { "Ca 1", "08:00 - 10:00" },
                                        { "Ca 2", "10:00 - 12:00" },
                                        { "Ca 3", "13:30 - 15:30" },
                                        { "Ca 4", "17:30 - 19:30" }
                                        };
                    }
                    @foreach (var shift in shifts)
                    {
                        <label class="inline-flex items-center p-2 border rounded-md cursor-pointer hover:bg-white transition">
                            <input type="radio" name="shiftSelection" value="@shift.Key (@shift.Value)" class="schedule-shift form-radio h-4 w-4 text-brand-blue border-gray-300" />
                            <span class="ml-2 text-sm text-gray-700">
                                <strong>@shift.Key</strong> <span class="text-xs text-gray-500">(@shift.Value)</span>
                            </span>
                        </label>
                    }
                </div>
            </div>

            <div class="mt-3 p-2 bg-blue-50 rounded text-sm text-brand-blue">
                <strong>Hiện tại: </strong> <span id="schedulePreview">@Model.Schedule</span>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const days = document.querySelectorAll('.schedule-day');
                const shifts = document.querySelectorAll('.schedule-shift');
                const input = document.getElementById('ScheduleInput');
                const preview = document.getElementById('schedulePreview');

                // --- LOGIC KHÔI PHỤC DỮ LIỆU CŨ ---
                const currentSchedule = input.value; // Ví dụ: "T2, T4 | Ca 1 (08:00 - 10:00)"

                if (currentSchedule) {
                    // 1. Check các thứ
                    days.forEach(cb => {
                        if (currentSchedule.includes(cb.value)) cb.checked = true;
                    });
                    // 2. Check ca (so sánh chuỗi)
                    shifts.forEach(rb => {
                        if (currentSchedule.includes(rb.value)) rb.checked = true;
                    });
                }
                // ----------------------------------

                function updateSchedule() {
                    const selectedDays = Array.from(days).filter(cb => cb.checked).map(cb => cb.value).join(', ');
                    let selectedShift = '';
                    shifts.forEach(rb => { if (rb.checked) selectedShift = rb.value; });

                    if (selectedDays && selectedShift) {
                        const result = `${selectedDays} | ${selectedShift}`;
                        input.value = result;
                        preview.textContent = result;
                    }
                }

                days.forEach(cb => cb.addEventListener('change', updateSchedule));
                shifts.forEach(rb => rb.addEventListener('change', updateSchedule));
            });
        </script>
        @* --- KẾT THÚC --- *@

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="StartDate" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="StartDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="StartDate" class="text-red-600 text-sm"></span>
            </div>
            <div>
                <label asp-for="EndDate" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="EndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="EndDate" class="text-red-600 text-sm"></span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="MinStudents" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="MinStudents" type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="MinStudents" class="text-red-600 text-sm"></span>
            </div>
            <div>
                <label asp-for="MaxStudents" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="MaxStudents" type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="MaxStudents" class="text-red-600 text-sm"></span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="Format" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="Format" asp-items="Html.GetEnumSelectList<ClassFormat>()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm"></select>
            </div>
            <div>
                <label asp-for="Status" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="Status" asp-items="Html.GetEnumSelectList<ClassStatus>()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm"></select>
                <span asp-validation-for="Status" class="text-red-600 text-sm"></span>
            </div>
        </div>

        <div class="mb-4">
            <label asp-for="Location" class="block text-sm font-medium text-gray-700"></label>
            <input asp-for="Location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
            <span asp-validation-for="Location" class="text-red-600 text-sm"></span>
        </div>

        <div class="mb-4">
            <label asp-for="MeetingUrl" class="block text-sm font-medium text-gray-700"></label>
            <input asp-for="MeetingUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
            <span asp-validation-for="MeetingUrl" class="text-red-600 text-sm"></span>
        </div>

        <div class="mt-6 flex items-center space-x-4">
            <input type="submit" value="Lưu thay đổi" class="px-6 py-2 bg-brand-blue text-white rounded-lg shadow hover:bg-blue-700 transition duration-300 cursor-pointer" />
            <a asp-action="Index" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300">Quay lại Danh sách</a>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}