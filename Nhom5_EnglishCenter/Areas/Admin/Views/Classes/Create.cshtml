@model TrungTamAnhNgu.Web.ViewModels.ClassViewModel
@using TrungTamAnhNgu.Web.Models

@{
    ViewData["Title"] = "Mở Lớp học mới";
}

<h1 class="text-3xl font-bold text-gray-800 mb-6">@ViewData["Title"]</h1>

<div class="bg-white shadow-md rounded-lg p-8 max-w-2xl">
    <form asp-action="Create">
        <div asp-validation-summary="ModelOnly" class="text-red-600 text-sm mb-4" role="alert"></div>

        <div class="mb-4">
            <label asp-for="ClassName" class="block text-sm font-medium text-gray-700"></label>
            <input asp-for="ClassName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
            <span asp-validation-for="ClassName" class="text-red-600 text-sm"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="CourseId" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="CourseId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" asp-items="ViewBag.CourseId"></select>
            </div>
            <div>
                <label asp-for="TeacherId" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="TeacherId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" asp-items="ViewBag.TeacherId"></select>
            </div>
        </div>

        @* --- GIAO DIỆN CHỌN LỊCH HỌC (DẠNG MA TRẬN) --- *@
        <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <label class="block text-sm font-bold text-gray-700 mb-2">Thời khóa biểu chi tiết</label>
            <input asp-for="Schedule" type="hidden" id="ScheduleInput" />
            <span asp-validation-for="Schedule" class="text-red-600 text-sm"></span>

            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2 border text-center w-20">Ca / Thứ</th>
                            @foreach (var day in new[] { "T2", "T3", "T4", "T5", "T6", "T7", "CN" })
                            {
                                <th class="p-2 border text-center font-semibold text-gray-700">@day</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var shifts = new Dictionary<int, string> { { 1, "08:00-10:00" }, { 2, "10:00-12:00" }, { 3, "13:30-15:30" }, { 4, "17:30-19:30" } };
                        }
                        @foreach (var shift in shifts)
                        {
                            <tr>
                                <td class="p-2 border font-bold text-brand-blue text-center bg-gray-50">
                                    Ca @shift.Key<br /><span class="text-xs text-gray-500 font-normal">@shift.Value</span>
                                </td>
                                @foreach (var day in new[] { "T2", "T3", "T4", "T5", "T6", "T7", "CN" })
                                {
                                    <td class="p-2 border text-center hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('cb_@day@shift.Key').click()">
                                        <input type="checkbox" id="cb_@day@shift.Key"
                                               data-day="@day" data-shift="@shift.Key"
                                               class="schedule-checkbox w-5 h-5 text-brand-blue rounded border-gray-300 focus:ring-brand-blue cursor-pointer"
                                               onclick="event.stopPropagation()" />
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-3 text-sm text-gray-600">
                <strong>Đã chọn: </strong> <span id="schedulePreview" class="text-brand-blue font-medium">Chưa chọn</span>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const checkboxes = document.querySelectorAll('.schedule-checkbox');
                const input = document.getElementById('ScheduleInput');
                const preview = document.getElementById('schedulePreview');

                function updateSchedule() {
                    // Gom nhóm theo Thứ: { "T2": [1, 2], "T4": [1] }
                    let selection = {};

                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            let d = cb.getAttribute('data-day');
                            let s = cb.getAttribute('data-shift');
                            if (!selection[d]) selection[d] = [];
                            selection[d].push(s);
                        }
                    });

                    // Chuyển thành chuỗi: "T2 (Ca 1, Ca 2); T4 (Ca 1)"
                    let parts = [];
                    // Thứ tự hiển thị đúng T2 -> CN
                    const dayOrder = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"];

                    dayOrder.forEach(day => {
                        if (selection[day]) {
                            let shifts = selection[day].sort().map(s => "Ca " + s).join(", ");
                            parts.push(`${day} (${shifts})`);
                        }
                    });

                    if (parts.length > 0) {
                        let result = parts.join("; ");
                        input.value = result;
                        preview.textContent = result;
                    } else {
                        input.value = '';
                        preview.textContent = 'Chưa chọn';
                    }
                }

                checkboxes.forEach(cb => cb.addEventListener('change', updateSchedule));
            });
        </script>

        @* --- KẾT THÚC GIAO DIỆN CHỌN LỊCH HỌC --- *@

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="StartDate" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="StartDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="StartDate" class="text-red-600 text-sm"></span>
            </div>
            <div>
                <label asp-for="EndDate" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="EndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="EndDate" class="text-red-600 text-sm"></span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="MinStudents" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="MinStudents" type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="MinStudents" class="text-red-600 text-sm"></span>
            </div>
            <div>
                <label asp-for="MaxStudents" class="block text-sm font-medium text-gray-700"></label>
                <input asp-for="MaxStudents" type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
                <span asp-validation-for="MaxStudents" class="text-red-600 text-sm"></span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <label asp-for="Format" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="Format" asp-items="Html.GetEnumSelectList<ClassFormat>()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm">
                </select>
            </div>
            <div>
                <label asp-for="Status" class="block text-sm font-medium text-gray-700"></label>
                <select asp-for="Status" asp-items="Html.GetEnumSelectList<ClassStatus>()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm">
                </select>
                <span asp-validation-for="Status" class="text-red-600 text-sm"></span>
            </div>
        </div>

        <div class="mb-4">
            <label asp-for="Location" class="block text-sm font-medium text-gray-700"></label>
            <input asp-for="Location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
            <span asp-validation-for="Location" class="text-red-600 text-sm"></span>
        </div>

        <div class="mb-4">
            <label asp-for="MeetingUrl" class="block text-sm font-medium text-gray-700"></label>
            <input asp-for="MeetingUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-blue focus:ring-brand-blue sm:text-sm" />
            <span asp-validation-for="MeetingUrl" class="text-red-600 text-sm"></span>
        </div>

        <div class="mt-6 flex items-center space-x-4">
            <input type="submit" value="Tạo mới" class="px-6 py-2 bg-brand-blue text-white rounded-lg shadow hover:bg-blue-700 transition duration-300 cursor-pointer" />
            <a asp-action="Index" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300">Quay lại Danh sách</a>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}